<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voting System | Cogon National High School</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwtxevaFgsp37s2xvHgJ_7vFBX595vZXw",
            authDomain: "g-evote.firebaseapp.com",
            projectId: "g-evote",
            databaseURL: "https://g-evote-default-rtdb.firebaseio.com",
            storageBucket: "g-evote.firebasestorage.app",
            messagingSenderId: "543011693024",
            appId: "1:543011693024:web:57899cd8d3021a10004b85"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let db = null;
        let allVoters = [], allCandidates = [], currentTally = {}, tieResolutions = {};
        const POSITIONS = ["President", "Vice-President", "Secretary", "Treasurer", "Auditor", "PIO", "Protocol Officer", "Grade 8 Rep", "Grade 9 Rep", "Grade 10 Rep", "Grade 11 Rep", "Grade 12 Rep"];

        const genID = () => {
            const chars = "2346789ABCDEFGHJKMNPRTUVWXYZ";
            let res = "";
            for (let i = 0; i < 6; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return res;
        };

        window.showStatusModal = (t, m) => { 
            document.getElementById('smTitle').innerText = t; 
            document.getElementById('smMsg').innerText = m; 
            document.getElementById('statusModal').style.display='flex'; 
        };

        window.adminAuth = async () => {
            const e = document.getElementById('adminUser').value.trim();
            const p = document.getElementById('adminPass').value.trim();
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, e, p);
            } catch (err) { window.showStatusModal("Auth Failed", "Invalid credentials."); }
        };

        window.logout = () => signOut(auth).then(() => { window.showView('loginView'); });
        
        window.voterLogout = () => {
            window.voterSession = null;
            document.getElementById('voterIdInput').value = '';
            document.getElementById('receiptModal').style.display = 'none';
            window.showView('loginView');
        };

        window.loginVoter = async () => {
            const id = document.getElementById('voterIdInput').value.trim().toUpperCase();
            if(id === "999999") { document.getElementById('adminUser').focus(); return; }
            try {
                const s = await get(ref(db, `voters/${id}`));
                if(s.exists()){
                    const v = s.val();
                    window.voterSession = { ...v, id };
                    document.getElementById('displayVoterName').innerText = `${v.FirstName} ${v.LastName}`;
                    if(v.hasVoted) { window.showReceipt(v.receipt, v); return; }
                    await window.loadBallot(v.GradeLevel);
                    window.showView('voterView');
                } else window.showStatusModal("Access Denied", "Voter ID not recognized.");
            } catch (e) { console.error(e); }
        };

        window.showReceipt = (rData, voter) => {
            let html = '';
            POSITIONS.forEach(pos => { if (rData?.[pos]) html += `<div class="receipt-row"><span>${pos}</span><b>${rData[pos]}</b></div>`; });
            document.getElementById('receiptContent').innerHTML = html;
            document.getElementById('receiptVoterName').innerText = `${voter.FirstName} ${voter.LastName}`;
            document.getElementById('receiptTimestamp').innerText = new Date().toLocaleString();
            document.getElementById('receiptModal').style.display = 'flex';
        };

        window.submitVote = async () => {
            const rds = document.querySelectorAll('input[type="radio"]:checked');
            if(!rds.length) return window.showStatusModal("Ballot Empty", "Select candidates.");
            const receipt = {};
            rds.forEach(r => { receipt[r.name] = r.getAttribute('data-name'); });
            const updates = {};
            for(let r of rds) {
                const cur = currentTally[r.value] || 0;
                updates[`tally/${r.value}`] = cur + 1;
            }
            updates[`voters/${window.voterSession.id}/hasVoted`] = true;
            updates[`voters/${window.voterSession.id}/receipt`] = receipt;
            await update(ref(db), updates);
            window.showReceipt(receipt, window.voterSession);
        };

        window.editVoter = (id) => {
            const v = allVoters.find(x => x.VoterID === id);
            if(!v) return;
            document.getElementById('editVoterId').value = id;
            document.getElementById('editVFName').value = v.FirstName || '';
            document.getElementById('editVLName').value = v.LastName || '';
            document.getElementById('editVGrade').value = v.GradeLevel || '';
            document.getElementById('editVSection').value = v.Section || '';
            document.getElementById('editVoterModal').style.display = 'flex';
        };

        window.saveVoterEdit = async () => {
            const id = document.getElementById('editVoterId').value;
            const updates = {
                FirstName: document.getElementById('editVFName').value.trim(),
                LastName: document.getElementById('editVLName').value.trim(),
                GradeLevel: document.getElementById('editVGrade').value.trim(),
                Section: document.getElementById('editVSection').value.trim()
            };
            await update(ref(db, `voters/${id}`), updates);
            document.getElementById('editVoterModal').style.display = 'none';
        };

        window.uploadVoters = (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = async (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const updates = {};
                let added = 0, skipped = 0;
                const existingKeys = new Set(allVoters.map(v => `${v.FirstName?.toLowerCase().trim()}|${v.LastName?.toLowerCase().trim()}`));
                json.forEach(v => {
                    const key = `${v.FirstName?.toLowerCase().trim()}|${v.LastName?.toLowerCase().trim()}`;
                    if (existingKeys.has(key)) skipped++;
                    else {
                        const id = genID();
                        updates[`voters/${id}`] = { ...v, VoterID: id, hasVoted: false };
                        existingKeys.add(key); added++;
                    }
                });
                if (Object.keys(updates).length > 0) await update(ref(db), updates);
                window.showStatusModal("Upload Finished", `Added: ${added}, Skipped: ${skipped}`);
                e.target.value = '';
            };
            r.readAsArrayBuffer(f);
        };

        window.downloadTemplate = () => {
            const data = [{ FirstName: "Juan", LastName: "Dela Cruz", GradeLevel: "10", Section: "Narra" }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Voter_Template.xlsx");
        };

        window.exportVoterList = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const sortedVoters = [...allVoters].sort((a, b) => (a.Section || '').localeCompare(b.Section || ''));
            const sections = {};
            sortedVoters.forEach(v => {
                const secName = v.Section || 'N/A';
                if (!sections[secName]) sections[secName] = [];
                sections[secName].push([`${v.LastName}, ${v.FirstName}`, v.GradeLevel, v.VoterID]);
            });
            Object.keys(sections).forEach((sectionName, index) => {
                if (index > 0) doc.addPage();
                doc.setFillColor(255, 123, 0); doc.rect(0, 0, pageWidth, 40, 'F');
                doc.setTextColor(255, 255, 255); doc.setFontSize(18);
                doc.text("VOTER ACCESS CODES", pageWidth / 2, 18, { align: "center" });
                doc.setFontSize(14); doc.text(`SECTION: ${sectionName.toUpperCase()}`, pageWidth / 2, 28, { align: "center" });
                doc.autoTable({ head: [['NAME', 'GRADE', 'ACCESS CODE']], body: sections[sectionName], startY: 50, headStyles: { fillColor: [30, 41, 59] } });
            });
            doc.save("Voter_Codes.pdf");
        };

        window.generateFinalReport = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const totalReg = allVoters.length;
            const totalVoted = allVoters.filter(x => x.hasVoted).length;
            const totalPending = totalReg - totalVoted;

            doc.setFillColor(255, 123, 0); doc.rect(0, 0, pageWidth, 45, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22);
            doc.text("OFFICIAL ELECTION RESULTS", pageWidth / 2, 20, { align: "center" });
            doc.setFontSize(10); doc.text("COGON NATIONAL HIGH SCHOOL • ONLINE SSLG ELECTION", pageWidth / 2, 28, { align: "center" });
            
            doc.setTextColor(30, 41, 59); doc.setFontSize(14); doc.text("ELECTION TURNOUT SUMMARY", 14, 60);
            doc.autoTable({
                startY: 65,
                head: [['DESCRIPTION', 'COUNT', 'PERCENTAGE']],
                body: [
                    ['Total Expected Voters', totalReg, '100%'],
                    ['Total Successful Votes', totalVoted, `${((totalVoted/totalReg)*100).toFixed(1)}%`],
                    ['Voters who did not cast vote', totalPending, `${((totalPending/totalReg)*100).toFixed(1)}%`]
                ],
                headStyles: { fillColor: [255, 123, 0] }
            });

            let currentY = doc.lastAutoTable.finalY + 15;
            doc.setTextColor(255, 123, 0); doc.text("OFFICIAL LIST OF ELECTED OFFICERS", 14, currentY);
            
            const winnersBody = [];
            POSITIONS.forEach(pos => {
                const cands = allCandidates.filter(c => c.Position === pos);
                if(cands.length > 0) {
                    const maxVotes = Math.max(...cands.map(c => currentTally[c.CandidateID] || 0));
                    const tiedCands = cands.filter(c => (currentTally[c.CandidateID] || 0) === maxVotes);
                    let elected = tiedCands.length > 1 ? (tieResolutions[pos] ? allCandidates.find(x => x.CandidateID === tieResolutions[pos]).FirstName + " (RESOLVED)" : "TIE") : tiedCands[0].FirstName + " " + tiedCands[0].LastName;
                    winnersBody.push([pos, elected, tiedCands[0].GradeLevel || 'N/A', maxVotes]);
                }
            });
            doc.autoTable({ startY: currentY + 5, head: [['POSITION', 'ELECTED OFFICER', 'GRADE', 'VOTES']], body: winnersBody, headStyles: { fillColor: [30, 41, 59] } });

            currentY = doc.lastAutoTable.finalY + 15;
            doc.text("DETAILED CANDIDATE PERFORMANCE", 14, currentY);
            POSITIONS.forEach(pos => {
                const cands = allCandidates.filter(c => c.Position === pos);
                if(cands.length > 0) {
                    const rows = cands.map(c => {
                        const vts = currentTally[c.CandidateID] || 0;
                        const perc = totalVoted > 0 ? ((vts / totalVoted) * 100).toFixed(1) : 0;
                        return [c.LastName, c.FirstName, c.Section, vts, `${perc}%`];
                    });
                    doc.autoTable({ startY: currentY + 5, head: [[pos.toUpperCase(), 'FIRST NAME', 'SECTION', 'VOTES', '% TOTAL']], body: rows });
                    currentY = doc.lastAutoTable.finalY + 10;
                    if(currentY > 260) { doc.addPage(); currentY = 20; }
                }
            });
            doc.save("COGONNHS_SSLG_ONLINE_ELECTION.pdf");
        };

        window.deleteSelectedVoters = async () => {
            const sel = Array.from(document.querySelectorAll('.v-check:checked'));
            if(!sel.length) return;
            if(confirm(`Delete ${sel.length} selected voters?`)) {
                for(let item of sel) { await remove(ref(db, `voters/${item.value}`)); await remove(ref(db, `candidates/${item.value}`)); }
            }
        };

        window.resetElectionData = async () => {
            const checks = document.querySelectorAll('.reset-check');
            if(!Array.from(checks).every(c => c.checked)) return alert("Confirm all risks.");
            try {
                await remove(ref(db, 'tally'));
                await remove(ref(db, 'resolutions'));
                const updates = {};
                allVoters.forEach(v => {
                    updates[`voters/${v.VoterID}/hasVoted`] = false;
                    updates[`voters/${v.VoterID}/receipt`] = null;
                });
                if (Object.keys(updates).length > 0) await update(ref(db), updates);
                document.getElementById('resetModal').style.display = 'none';
                alert("Reset Successful");
            } catch (e) { alert("Error: " + e.message); }
        };

        window.resolveTie = async (pos, cid) => { await set(ref(db, `resolutions/${pos}`), cid); window.showStatusModal("Resolved", `Winner set for ${pos}.`); };
        
        window.showView = (v) => { 
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); 
            document.getElementById(v).classList.add('active'); 
        };

        window.showAdminSection = (sid) => { 
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none'); 
            document.getElementById(sid).style.display = 'block'; 
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
            const btn = Array.from(document.querySelectorAll('.side-btn')).find(el => el.getAttribute('onclick')?.includes(sid));
            if(btn) btn.classList.add('active');
        };

        window.addAsCandidate = async (vId) => {
            const v = allVoters.find(x => x.VoterID === vId);
            if(v) {
                await set(ref(db, `candidates/${vId}`), { ...v, CandidateID: vId, Position: "President" });
                document.getElementById('addCandidateModal').style.display = 'none';
                window.showStatusModal("Success", "Student added as candidate.");
            }
        };

        window.removeCandidate = async (vId) => {
            if(confirm("Remove this student from the candidate list?")) {
                await remove(ref(db, `candidates/${vId}`));
            }
        };

        window.filterCandidateSearch = () => {
            const q = document.getElementById('candSearchInput').value.toLowerCase();
            document.getElementById('candSearchResults').innerHTML = allVoters
                .filter(v => (v.FirstName + " " + v.LastName).toLowerCase().includes(q))
                .slice(0, 10)
                .map(v => `<div class="search-result-item" onclick="addAsCandidate('${v.VoterID}')"><b>${v.FirstName} ${v.LastName}</b><small>${v.Section}</small></div>`)
                .join('');
        };

        window.saveCandidates = async () => {
            const selects = document.querySelectorAll('.assign-card select');
            for (let sel of selects) {
                const vId = sel.id.replace('role-sel-', '');
                const pos = sel.value;
                if (pos) await update(ref(db, `candidates/${vId}`), { Position: pos });
            }
            window.showStatusModal("Success", "Roles updated.");
        };

        window.filterData = (type) => {
            const query = document.getElementById(type + 'Search').value.toLowerCase();
            const target = type === 'pending' ? 'pendingTableBody' : (type === 'voters' ? 'votersTableBody' : 'candidateAssignList');
            const items = document.querySelectorAll(`#${target} tr, #${target} .assign-card`);
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(query) ? '' : (item.classList.contains('sec-header') ? '' : 'none');
            });
        };

        try {
            db = getDatabase(app);
            onValue(ref(db, '/'), (s) => {
                const d = s.val() || {}; 
                allVoters = Object.values(d.voters || {}); 
                allCandidates = Object.values(d.candidates || {}).sort((a,b) => POSITIONS.indexOf(a.Position) - POSITIONS.indexOf(b.Position)); 
                currentTally = d.tally || {};
                tieResolutions = d.resolutions || {};
                
                document.getElementById('statTotal').innerText = allVoters.length;
                document.getElementById('statVoted').innerText = allVoters.filter(x => x.hasVoted).length;
                const perc = allVoters.length > 0 ? ((allVoters.filter(x => x.hasVoted).length / allVoters.length) * 100).toFixed(1) : 0;
                document.getElementById('turnoutPerc').innerText = `${perc}%`;
                document.getElementById('progressFill').style.width = `${perc}%`;
                
                let standingHtml = '';
                POSITIONS.forEach(pos => {
                    const cands = allCandidates.filter(c => c.Position === pos);
                    if(cands.length > 0) {
                        const maxVotes = Math.max(...cands.map(c => currentTally[c.CandidateID] || 0));
                        const tiedCands = cands.filter(x => (currentTally[x.CandidateID] || 0) === maxVotes);
                        cands.forEach(c => {
                            const votes = currentTally[c.CandidateID] || 0;
                            const isWinner = votes === maxVotes && maxVotes > 0;
                            const isTie = tiedCands.length > 1;
                            standingHtml += `<tr><td><span class="role-token">${c.Position}</span></td><td><b>${c.FirstName} ${c.LastName}</b></td><td><span class="count-pill">${votes}</span> ${isWinner && isTie ? `<button class="winner-badge tie" onclick="resolveTie('${c.Position}','${c.CandidateID}')">Tie: Pick Winner</button>` : (isWinner ? '<span class="winner-badge">Winning</span>' : '')}</td></tr>`;
                        });
                    }
                });
                document.getElementById('liveStandingTable').innerHTML = standingHtml;
                document.getElementById('votersTableBody').innerHTML = allVoters.map(v => `<tr><td><input type="checkbox" class="v-check" value="${v.VoterID}"></td><td><span class="id-token">${v.VoterID}</span></td><td><b>${v.FirstName} ${v.LastName}</b></td><td><span class="chip ${v.hasVoted?'voted':'idle'}">${v.hasVoted?'VOTED':'PENDING'}</span></td><td><button class="btn-edit" onclick="editVoter('${v.VoterID}')">Edit</button></td></tr>`).join('');
                
                const pend = allVoters.filter(v => !v.hasVoted).sort((a,b) => (a.Section || '').localeCompare(b.Section || ''));
                let pendHtml = '', lastSec = '';
                pend.forEach(v => {
                    if(v.Section !== lastSec) { pendHtml += `<tr class="sec-header"><td colspan="3">Section: ${v.Section || 'N/A'}</td></tr>`; lastSec = v.Section; }
                    pendHtml += `<tr><td><span class="id-token">${v.VoterID}</span></td><td><b>${v.FirstName} ${v.LastName}</b></td><td>Grade ${v.GradeLevel}</td></tr>`;
                });
                document.getElementById('pendingTableBody').innerHTML = pendHtml;
                
                document.getElementById('candidateAssignList').innerHTML = allCandidates.map(c => {
                    return `<div class="assign-card"><div class="assign-info"><strong>${c.FirstName} ${c.LastName}</strong><small>${c.Section}</small></div><div style="display:flex; gap:10px; align-items:center;"><select class="pos-select-styled" id="role-sel-${c.CandidateID}">${POSITIONS.map(p => `<option value="${p}" ${c.Position === p ? 'selected' : ''}>${p}</option>`).join('')}</select><button class="btn-edit" style="background:#fee2e2; color:#ef4444;" onclick="removeCandidate('${c.CandidateID}')">✕</button></div></div>`;
                }).join('');
            });
        } catch(e) { console.error(e); }

        window.loadBallot = async (vGrade) => {
            const c = (await get(ref(db, 'candidates'))).val() || {};
            const b = document.getElementById('ballotContainer'); b.innerHTML = '';
            POSITIONS.slice(0, 7).forEach(p => window.renderPos(c, p, b));
            const gn = parseInt(vGrade);
            if (gn >= 7 && gn <= 11) window.renderPos(c, `Grade ${gn + 1} Rep`, b);
        };

        window.renderPos = (cands, pos, cont) => {
            const list = Object.values(cands).filter(c => c.Position === pos);
            if(list.length) {
                let h = `<div class="ballot-category"><div class="category-divider"><span class="category-label">${pos}</span><div class="divider-line"></div></div><div class="candidate-grid">`;
                list.forEach(c => { h += `<label class="cand-card"><input type="radio" name="${pos}" data-name="${c.FirstName} ${c.LastName}" value="${c.CandidateID}"><div class="cand-card-inner"><div class="check-orb"></div><div class="cand-details"><span class="c-name">${c.FirstName} ${c.LastName}</span></div></div></label>`; });
                cont.innerHTML += h + `</div></div>`;
            }
        };

        onAuthStateChanged(auth, (u) => { if(u) { window.showView('adminView'); window.showAdminSection('dashSection'); } else { window.showView('loginView'); } });
    </script>
    <style>
        :root { --orange: #ff7b00; --nav: #1e293b; --bg: #f8fafc; --white: #fff; --border: #e2e8f0; --glass: rgba(255, 255, 255, 0.98); }
        body, html { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .view { display: none; height: 100vh; width: 100vw; flex-direction: row; }
        .view.active { display: flex; }
        .sidebar { width: 280px; min-width: 280px; background: var(--nav); color: white; padding: 30px 20px; display: flex; flex-direction: column; z-index: 100; transition: 0.3s; }
        .sidebar h2 { color: var(--orange); margin: 0 0 40px 0; font-weight: 900; }
        @media (max-width: 992px) {
            .view { flex-direction: column; }
            .sidebar { width: 100%; min-width: 100%; height: auto; padding: 15px; flex-direction: row; align-items: center; overflow-x: auto; white-space: nowrap; border-bottom: 3px solid var(--orange); }
            .sidebar h2 { display: none; }
            .side-btn { margin-bottom: 0; margin-right: 10px; display: inline-block; font-size: 13px; }
            .sidebar > div:last-child { margin-top: 0 !important; margin-left: auto; display: flex; gap: 5px; }
        }
        .side-btn { padding: 14px 20px; border-radius: 12px; cursor: pointer; margin-bottom: 8px; font-weight: 700; color: #94a3b8; transition: 0.3s; }
        .side-btn.active { background: var(--orange); color: white; }
        .main-stage { flex: 1; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        @media (max-width: 600px) { .main-stage { padding: 15px; } }
        .metric-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card-stat { background: white; padding: 20px; border-radius: 20px; border-left: 5px solid var(--orange); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .card-stat h1 { font-size: clamp(24px, 5vw, 32px); color: var(--orange); margin: 5px 0 0; }
        .progress-rail { height: 12px; background: #e2e8f0; border-radius: 10px; margin-bottom: 35px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--orange); transition: 1s ease; }
        .data-table-card { background: white; padding: clamp(15px, 3vw, 25px); border-radius: 25px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 550px; }
        td { padding: 15px; background: #fff; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .candidate-grid, .assign-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        @media (max-width: 480px) { .candidate-grid, .assign-grid { grid-template-columns: 1fr; } }
        .assign-card { background: #fff; padding: 20px; border-radius: 22px; border: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .ballot-category { margin-bottom: 50px; }
        .category-divider { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .category-label { background: var(--nav); color: white; padding: 8px 25px; border-radius: 30px; font-weight: 800; font-size: 14px; }
        .divider-line { flex: 1; height: 3px; background: var(--orange); opacity: 0.3; }
        .cand-card input { display: none; }
        .cand-card-inner { background: white; padding: clamp(15px, 4vw, 25px); border-radius: 20px; display: flex; align-items: center; border: 2px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .cand-card input:checked + .cand-card-inner { border-color: var(--orange); background: #fffaf5; transform: scale(1.02); }
        .modal-glass { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .modal-body { background: var(--white); width: 100%; max-width: 500px; border-radius: 35px; padding: clamp(20px, 5vw, 40px); border-top: 12px solid var(--orange); max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3); }
        .btn-prime { background: var(--orange); color: white; border: none; padding: 18px; border-radius: 18px; font-weight: 800; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; -webkit-appearance: none; }
        .login-input { width: 100%; padding: 18px; border-radius: 15px; border: 2px solid #e2e8f0; margin-bottom: 15px; outline: none; font-size: 16px; box-sizing: border-box; background: #f8fafc; transition: 0.2s; }
        .winner-badge { background: #22c55e; color: white; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 900; border:none; }
        .winner-badge.tie { background: #ef4444; cursor: pointer; }
        .search-result-item { padding: 15px; border-radius: 12px; margin-bottom: 8px; background: #f1f5f9; cursor: pointer; display: flex; flex-direction: column; }
        .pos-select-styled { padding: 10px; border-radius: 12px; border: 2px solid #e2e8f0; font-weight: 600; outline: none; max-width: 160px; }
        .receipt-body { background:#fff; padding:30px; border-radius:20px; width:100%; max-width:350px; border-top: 10px solid var(--orange); box-sizing: border-box; font-family: 'Courier New', monospace; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px dotted #ccc; padding-bottom: 4px; text-transform: uppercase; }
        .login-wrapper { flex: 1; display: flex; flex-direction: row; }
        @media (max-width: 768px) { .login-wrapper { flex-direction: column; } .login-wrapper > div { padding: 12% 8% !important; border: none !important; } }
    </style>
</head>
<body>
    <input type="file" id="vUpload" style="display:none;" accept=".xlsx, .xls" onchange="uploadVoters(event)">
    <div id="addCandidateModal" class="modal-glass">
        <div class="modal-body">
            <h2 style="margin-top:0;">Add New Candidate</h2>
            <input type="text" id="candSearchInput" class="login-input" placeholder="Type name..." onkeyup="filterCandidateSearch()">
            <div id="candSearchResults" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            <button class="btn-prime" style="background:#f1f5f9; color:#1e293b;" onclick="document.getElementById('addCandidateModal').style.display='none'">CLOSE</button>
        </div>
    </div>
    <div id="resetModal" class="modal-glass">
        <div class="modal-body">
            <h2 style="color:#ef4444; margin-top:0;">CRITICAL RESET</h2>
            <div style="margin-bottom:12px;"><input type="checkbox" class="reset-check"> Wipe tallies</div>
            <div style="margin-bottom:12px;"><input type="checkbox" class="reset-check"> Clear status</div>
            <div style="margin-bottom:20px;"><input type="checkbox" class="reset-check"> Delete receipts</div>
            <button class="btn-prime" style="background:#ef4444;" onclick="resetElectionData()">CLEAR ALL DATA</button>
            <button class="btn-prime" style="background:#f1f5f9; color:#1e293b; margin-top:10px;" onclick="document.getElementById('resetModal').style.display='none'">CANCEL</button>
        </div>
    </div>
    <div id="editVoterModal" class="modal-glass">
        <div class="modal-body">
            <h2>Edit Voter</h2>
            <input type="hidden" id="editVoterId">
            <input type="text" id="editVFName" class="login-input" placeholder="First Name">
            <input type="text" id="editVLName" class="login-input" placeholder="Last Name">
            <input type="number" id="editVGrade" class="login-input" placeholder="Grade">
            <input type="text" id="editVSection" class="login-input" placeholder="Section">
            <button class="btn-prime" onclick="saveVoterEdit()">Save Changes</button>
            <button class="btn-prime" style="background:#f1f5f9; color:#475569; margin-top:10px;" onclick="document.getElementById('editVoterModal').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="liveStandingModal" class="modal-glass" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-body" style="max-width:700px;">
            <h2 style="color:var(--orange);">Real-Time Standings</h2>
            <div style="overflow-x:auto;"><table><tbody id="liveStandingTable"></tbody></table></div>
        </div>
    </div>
    <div id="statusModal" class="modal-glass"><div class="modal-body" style="text-align:center;">
        <h2 id="smTitle"></h2><p id="smMsg"></p>
        <button class="btn-prime" onclick="document.getElementById('statusModal').style.display='none'">CONTINUE</button>
    </div></div>
    <div id="receiptModal" class="modal-glass">
        <div class="receipt-body">
            <h3 style="text-align:center; border-bottom:2px dashed #333; padding-bottom:10px; margin-top:0;">VOTE RECEIPT</h3>
            <div id="receiptVoterName" style="text-align:center; font-weight:bold; margin-bottom:15px; font-size: 16px;"></div>
            <div id="receiptContent"></div>
            <div id="receiptTimestamp" style="font-size:11px; text-align:center; margin-top:20px; color:#666;"></div>
            <button class="btn-prime" onclick="voterLogout()" style="margin-top:20px;">Okay, thanks!</button>
        </div>
    </div>
    <div id="voterView" class="view" style="flex-direction: column;">
        <div style="background:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid var(--orange);">
            <div style="font-size:14px;"><b style="color:var(--orange);">Hi!</b> <span id="displayVoterName"></span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-prime" style="width:auto; padding:8px 15px; background:var(--nav); margin-top:0;" onclick="voterLogout()">Logout</button>
                <button class="btn-prime" style="width:auto; padding:8px 20px; margin-top:0;" onclick="submitVote()">CAST VOTE</button>
            </div>
        </div>
        <div style="flex:1; overflow-y:auto; padding:clamp(15px, 4vw, 40px);"><div id="ballotContainer" style="max-width:1200px; margin:0 auto;"></div></div>
    </div>
    <div id="adminView" class="view">
        <div class="sidebar">
            <h2>VOTING SYSTEM</h2>
            <div class="side-btn" onclick="showAdminSection('dashSection')">ANALYTICS</div>
            <div class="side-btn" onclick="showAdminSection('votersSection')">VOTERS</div>
 	    <div class="side-btn" onclick="showAdminSection('pendSection')">REMAINING</div>
            <div class="side-btn" onclick="showAdminSection('candidatesSection')">CANDIDATES</div>
            <div style="margin-top:auto;">
                <button class="side-btn" style="background:#ef4444; color:white; border:none; width:100%;" onclick="document.getElementById('resetModal').style.display='flex'">Reset</button>
                <button class="side-btn" style="background:var(--orange); color:white; border:none; width:100%; margin-top:5px;" onclick="logout()">Logout</button>
            </div>
        </div>
        <div class="main-stage">
            <div id="dashSection" class="admin-section">
                <div class="metric-row">
                    <div class="card-stat"><h3>Registered</h3><h1 id="statTotal">0</h1></div>
                    <div class="card-stat"><h3>Voted</h3><h1 id="statVoted">0</h1></div>
                    <div class="card-stat"><h3>Turnout</h3><h1 id="turnoutPerc">0%</h1></div>
                    <div class="card-stat" onclick="document.getElementById('liveStandingModal').style.display='flex'"><h3>Rankings</h3><h1 style="font-size:18px;">VIEW</h1></div>
                </div>
                <div class="progress-rail"><div id="progressFill" class="progress-fill"></div></div>
                <div class="data-table-card" style="text-align:center;"><button class="btn-prime" style="width:auto; padding:15px 30px;" onclick="generateFinalReport()">Download Official Results PDF</button></div>
            </div>
            <div id="votersSection" class="admin-section" style="display:none;">
                <div class="data-table-card">
                    <input type="text" id="votersSearch" class="login-input" placeholder="Search voters..." onkeyup="filterData('voters')">
                    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="btn-prime" style="width:auto; padding:10px 15px; font-size:12px; margin-top:0;" onclick="downloadTemplate()">Template</button>
                        <button class="btn-prime" style="width:auto; padding:10px 15px; font-size:12px; margin-top:0;" onclick="document.getElementById('vUpload').click()">Upload</button>
                        <button class="btn-prime" style="width:auto; padding:10px 15px; font-size:12px; margin-top:0;" onclick="exportVoterList()">Export</button>
                        <button class="btn-prime" style="width:auto; padding:10px 15px; font-size:12px; margin-top:0; background:#ef4444;" onclick="window.deleteSelectedVoters()">Delete</button>
                    </div>
                    <table><thead><tr><th></th><th>ID</th><th>Name</th><th>Status</th><th>Edit</th></tr></thead><tbody id="votersTableBody"></tbody></table>
                </div>
            </div>
            <div id="candidatesSection" class="admin-section" style="display:none;">
                <div class="data-table-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                        <h2 style="margin:0; color:var(--nav);">Candidate Pool</h2>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-prime" style="width:auto; padding:10px 20px; background:var(--nav); margin:0;" onclick="document.getElementById('addCandidateModal').style.display='flex'">+ Add</button>
                            <button class="btn-prime" style="width:auto; padding:10px 25px; margin:0;" onclick="window.saveCandidates()">Save</button>
                        </div>
                    </div>
                    <input type="text" id="candidatesSearch" class="login-input" placeholder="Filter..." onkeyup="filterData('candidates')">
                    <div id="candidateAssignList" class="assign-grid"></div>
                </div>
            </div>
            <div id="pendSection" class="admin-section" style="display:none;">
                <div class="data-table-card">
                    <h2>PENDING VOTERS</h2>
                    <input type="text" id="pendingSearch" class="login-input" placeholder="Search..." onkeyup="filterData('pending')">
                    <table><thead><tr><th>ID</th><th>Name</th><th>Grade</th></tr></thead><tbody id="pendingTableBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    <div id="loginView" class="view active">
        <div class="login-wrapper">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:8%; background:white;">
                <h1 style="font-size:clamp(50px, 12vw, 100px); color:var(--orange); letter-spacing:-6px; margin:0;">SSLG ELECTION</h1>
                <p style="font-weight:900; color:var(--nav); margin-bottom:40px;">COGON NATIONAL HIGH SCHOOL</p>
                <input type="text" id="voterIdInput" class="login-input" placeholder="Access Code" style="max-width:400px;">
                <button class="btn-prime" style="max-width:400px;" onclick="loginVoter()">START VOTING</button>
            </div>
            <div style="flex:1; background:#fffaf5; display:flex; flex-direction:column; justify-content:center; padding:8%; border-left:6px solid var(--orange);">
                <h3>Admin Login</h3>
                <input type="text" id="adminUser" class="login-input" placeholder="Email" style="max-width:400px;">
                <input type="password" id="adminPass" class="login-input" placeholder="Password" style="max-width:400px;">
                <button class="btn-prime" style="background:var(--nav); max-width:400px;" onclick="adminAuth()">LOGIN</button>
            </div>
        </div>
    </div>
</body>
</html>